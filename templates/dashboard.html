<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturer Dashboard - BlockVerify</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="/" style="text-decoration: none; color: white;">
                    <h2>🔗 BlockVerify</h2>
                </a>
            </div>
            <div class="nav-menu">
                <a href="/" class="nav-link">Home</a>
                <a href="/verify" class="nav-link">Verify Product</a>
                <a href="/dashboard" class="nav-link active">Dashboard</a>
            </div>

            <div class="nav-user">
                <div class="profile-icon" onclick="toggleDropdown()">
                    <span id="profile-letter" class="profile-letter"></span>
                </div>
                <div class="dropdown-toggle" id="profile-dropdown">
                    <div class="user-info">
                        <p id="user-email" class="user-email">Loading...</p>
                        <p id="company-name" class="company-name">Loading...</p>
                        <span id="wallet-address" class="wallet-address">Loading...</span>
                        <p id="verification-status" class="verification-status">Loading...</p>
                    </div>
                    <hr class="dropdown-divider">
                    <!-- <a class="nav-link" onclick="viewProfile()">View Profile</a> -->
                    <a href="/edit-profile" class="nav-link" onclick="editProfile()">Edit Profile</a>
                    <a href="#" class="nav-link" onclick="logout()">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="dashboard">
        <div class="container">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <h1 class="dashboard-title">Manufacturer Dashboard</h1>
                <p class="dashboard-subtitle">Manage your products and track blockchain registrations</p>
            </div>

            <!-- Dashboard Stats -->
            <div id="dashboard-stats" class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-products">Loading...</div>
                    <div class="stat-label">Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="blockchain-products">Loading...</div>
                    <div class="stat-label">On Blockchain</div>
                </div>
                <!-- <div class="stat-card">
                    <div class="stat-number" id="pending-products">Loading...</div>
                    <div class="stat-label">Pending Registration</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-verifications">Loading...</div>
                    <div class="stat-label">Verifications</div>
                </div> -->
            </div>

            <!-- Blockchain Connection Status -->
            <div class="connection-status" id="connection-status">
                <div class="status-indicator" id="blockchain-indicator">
                    <span class="status-dot"></span>
                    <span id="connection-text">Checking blockchain connection...</span>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-actions">
                <h3>Quick Actions</h3>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showProductForm()">Register New Product</button>
                    <button class="btn btn-outline" onclick="refreshDashboard()">Refresh Data</button>
                    <button class="btn btn-outline" onclick="connectWallet()">Connect MetaMask</button>
                </div>
            </div>

            <!-- Product Registration Form -->
<div class="product-form" id="product-form" style="display: none;">
    <h3>Register New Product on Blockchain</h3>
    <form id="product-registration-form">
        <div class="form-row">
            <div class="form-group">
                <label for="serial_number">Serial Number *</label>
                <input type="text" id="serial_number" name="serial_number" required 
                       placeholder="Enter unique serial number">
                <!-- <button type="button" class="btn btn-small" onclick="generateSerialNumber()" style="margin-top: 0.5rem;">
                    Generate Random Serial
                </button> -->
            </div>
            
            <div class="form-group">
                <label for="brand">Brand *</label>
                <input type="text" id="brand" name="brand" required 
                       placeholder="Enter brand name">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="model">Model *</label>
                <input type="text" id="model" name="model" required 
                       placeholder="Enter model name">
            </div>
            
            <div class="form-group">
                <label for="device_type">Device Type *</label>
                <select id="device_type" name="device_type" required>
                    <option value="">Select device type</option>
                    <option value="Smartphone">Smartphone</option>
                    <option value="Laptop">Laptop</option>
                    <option value="Tablet">Tablet</option>
                    <option value="Desktop">Desktop</option>
                    <option value="Monitor">Monitor</option>
                    <option value="Camera">Camera</option>
                    <option value="Audio Device">Audio Device</option>
                    <option value="Gaming Console">Gaming Console</option>
                    <option value="Smart Watch">Smart Watch</option>
                    <option value="Other">Other</option>
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="storage_data">Storage/Specs</label>
                <input type="text" id="storage_data" name="storage_data" 
                       placeholder="e.g., 256GB, 16GB RAM">
            </div>
            
            <div class="form-group">
                <label for="color">Color</label>
                <input type="text" id="color" name="color" 
                       placeholder="e.g., Black, Silver">
            </div>
        </div>
        
        <div class="form-group">
            <label for="batch_number">Batch Number</label>
            <input type="text" id="batch_number" name="batch_number" 
                   placeholder="Will auto-generate if empty">
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary" id="register-btn">
                <span class="btn-text">Register on Blockchain</span>
                <span class="btn-spinner" style="display: none;">Processing...</span>
            </button>
        </div>
    </form>
    
    <div style="text-align: center; margin-top: 1rem;">
        <button class="btn btn-outline" onclick="hideProductForm()">Cancel</button>
    </div>
</div>

<!-- Transfer Ownership Section -->
<div class="dashboard-actions" style="margin-top: 2rem;">
    <h3>Transfer Product Ownership</h3>
    <div class="action-buttons">
        <button class="btn btn-secondary" onclick="showTransferForm()">Transfer Ownership</button>
    </div>
</div>

            <!-- Transfer Form -->
            <div class="product-form" id="transfer-form" style="display: none;">
                <h3>Transfer Product Ownership</h3>
                <form id="ownership-transfer-form">
                    <div class="form-group">
                        <label for="transfer_serial">Select Product (Serial Number)</label>
                        <select id="transfer_serial" name="transfer_serial" required>
                            <option value="">Select product to transfer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="new_owner_address">New Owner Wallet Address *</label>
                        <input type="text" id="new_owner_address" name="new_owner_address" required 
                              placeholder="0x..." pattern="^0x[a-fA-F0-9]{40}$">
                        <small>Must be a valid Ethereum address (42 characters starting with 0x)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="transfer_reason">Transfer Reason *</label>
                        <select id="transfer_reason" name="transfer_reason" required>
                            <option value="">Select reason</option>
                            <option value="Sale">Sale</option>
                            <option value="Gift">Gift</option>
                            <option value="Warranty Replacement">Warranty Replacement</option>
                            <option value="Return/Exchange">Return/Exchange</option>
                            <option value="Business Transfer">Business Transfer</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="sale_price">Sale Price (ETH)</label>
                        <input type="number" id="sale_price" name="sale_price" step="0.001" min="0" 
                              placeholder="0.000">
                        <small>Enter 0 for gifts or non-sales transfers</small>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary" id="transfer-btn">
                            <span class="btn-text">Transfer Ownership</span>
                            <span class="btn-spinner" style="display: none;">Processing...</span>
                        </button>
                    </div>
                </form>
                
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn btn-outline" onclick="hideTransferForm()">Cancel</button>
                </div>
            </div>

            <!-- My Products Section -->
            <div class="dashboard-actions">
                <h3>My Registered Products</h3>
                <div class="products-filter">
                    <select id="products-filter" onchange="filterProducts()">
                        <option value="all">All Products</option>
                        <option value="blockchain_confirmed">Blockchain Registered</option>
                        <option value="blockchain_pending">Pending Registration</option>
                        <option value="blockchain_failed">Failed Registration</option>
                    </select>
                </div>
                <div id="manufacturer-products" class="products-grid">
                    <div class="loading"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Transaction Status Modal -->
    <div id="transaction-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Blockchain Registration Status</h3>
                <button onclick="closeTransactionModal()" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="transaction-status"></div>
            </div>
        </div>
    </div>
   
    <script>
      
    document.addEventListener('DOMContentLoaded', function() {
        const userString = localStorage.getItem('user');
        if (!userString) {
            window.location.href = '/';
            return;
        }
        
        try {
            const user = JSON.parse(userString);
            if (!user || user.role !== "manufacturer") {
                window.location.href = '/';
                return;
            }
        } catch (error) {
            console.error('Error parsing user data:', error);
            window.location.href = '/';
            return;
        }
    });

    // Fix the CONFIG setup - remove the double JSON.parse
    window.CONFIG = {
        CHAIN_ID: parseInt('{{ chain_id }}'),
        CONTRACT_ADDRESS: '{{ contract_address }}',
        WALLET_ADDRESS: '{{account_address}}',
        CONTRACT_ABI: [
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "string",
        "name": "serialNumber",
        "type": "string"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "manufacturer",
        "type": "address"
      }
    ],
    "name": "DeviceRegistered",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "string",
        "name": "serialNumber",
        "type": "string"
      },
      {
        "indexed": false,
        "internalType": "bool",
        "name": "isAuthentic",
        "type": "bool"
      }
    ],
    "name": "DeviceVerified",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "address",
        "name": "manufacturer",
        "type": "address"
      }
    ],
    "name": "ManufacturerAuthorized",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "string",
        "name": "serialNumber",
        "type": "string"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "from",
        "type": "address"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "to",
        "type": "address"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "price",
        "type": "uint256"
      }
    ],
    "name": "OwnershipTransferred",
    "type": "event"
  },
  {
    "inputs": [],
    "name": "admin",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "getAllAuthorizedManufacturers",
    "outputs": [
      {
        "internalType": "address[]",
        "name": "",
        "type": "address[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_serialNumber",
        "type": "string"
      }
    ],
    "name": "getDeviceDetails",
    "outputs": [
      {
        "internalType": "string",
        "name": "brand",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "model",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "deviceType",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "storageData",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "color",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "manufacturerName",
        "type": "string"
      },
      {
        "internalType": "address",
        "name": "currentOwner",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "manufacturingDate",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "_owner",
        "type": "address"
      }
    ],
    "name": "getOwnerDevices",
    "outputs": [
      {
        "internalType": "string[]",
        "name": "",
        "type": "string[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_serialNumber",
        "type": "string"
      }
    ],
    "name": "getOwnershipHistory",
    "outputs": [
      {
        "internalType": "address[]",
        "name": "previousOwners",
        "type": "address[]"
      },
      {
        "internalType": "address[]",
        "name": "newOwners",
        "type": "address[]"
      },
      {
        "internalType": "uint256[]",
        "name": "transferDates",
        "type": "uint256[]"
      },
      {
        "internalType": "string[]",
        "name": "transferReasons",
        "type": "string[]"
      },
      {
        "internalType": "uint256[]",
        "name": "salePrices",
        "type": "uint256[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "_manufacturer",
        "type": "address"
      }
    ],
    "name": "isManufacturerAuthorized",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_serialNumber",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_brand",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_model",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_deviceType",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_storage",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_color",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_batchNumber",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_specHash",
        "type": "string"
      }
    ],
    "name": "registerDevice",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_serialNumber",
        "type": "string"
      }
    ],
    "name": "serialExists",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_serialNumber",
        "type": "string"
      },
      {
        "internalType": "address",
        "name": "_newOwner",
        "type": "address"
      },
      {
        "internalType": "string",
        "name": "_transferReason",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "_salePrice",
        "type": "uint256"
      }
    ],
    "name": "transferOwnership",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "name": "verifiedManufacturers",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_serialNumber",
        "type": "string"
      }
    ],
    "name": "verifyDevice",
    "outputs": [
      {
        "internalType": "bool",
        "name": "exists",
        "type": "bool"
      },
      {
        "internalType": "bool",
        "name": "isAuthentic",
        "type": "bool"
      },
      {
        "internalType": "string",
        "name": "brand",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "model",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "deviceType",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "manufacturerName",
        "type": "string"
      },
      {
        "internalType": "address",
        "name": "currentOwner",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string[]",
        "name": "_serialNumbers",
        "type": "string[]"
      }
    ],
    "name": "verifyMultipleDevices",
    "outputs": [
      {
        "internalType": "bool[]",
        "name": "exists",
        "type": "bool[]"
      },
      {
        "internalType": "bool[]",
        "name": "isAuthentic",
        "type": "bool[]"
      },
      {
        "internalType": "string[]",
        "name": "brands",
        "type": "string[]"
      },
      {
        "internalType": "string[]",
        "name": "models",
        "type": "string[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  }
]
    };
    
    let web3;
    let contract;
    let userAccount;


// Updated showAlert function with warning type
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    
    let backgroundColor;
    switch(type) {
        case 'success': backgroundColor = '#10b981'; break;
        case 'error': backgroundColor = '#ef4444'; break;
        case 'warning': backgroundColor = '#f59e0b'; break;
        default: backgroundColor = '#3b82f6';
    }
    
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem;
        border-radius: 0.5rem;
        color: white;
        z-index: 10000;
        background-color: ${backgroundColor};
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        max-width: 400px;
    `;
    
    document.body.appendChild(alertDiv);
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}


function updateConnectionStatus(isConnected, account = '') {
    const connectionText = document.getElementById('connection-text');
    const statusDot = document.getElementsByClassName('status-dot')[0]; // Get the first element
    const blockchainIndicator = document.getElementById('blockchain-indicator');

    if (connectionText && blockchainIndicator && statusDot) {
        if (isConnected) {
            connectionText.textContent = `Connected: ${account.slice(0, 6)}...${account.slice(-4)}`;
            blockchainIndicator.classList.add('connected');
            statusDot.style.backgroundColor = '#10b981'; // Green
            statusDot.style.border = '2px solid #10b981';
            connectionText.style.color = '#10b981';
            blockchainIndicator.style.backgroundColor = '#f0fdf4'; // Light green background
        } else {
            connectionText.textContent = 'Not Connected - Please connect MetaMask';
            blockchainIndicator.classList.remove('connected');
            statusDot.style.backgroundColor = '#EF4444'; // Red
            statusDot.style.border = '2px solid #EF4444';
            connectionText.style.color = '#EF4444';
            blockchainIndicator.style.backgroundColor = '#fef2f2'; // Light red background
        }
    } else {
        // Default state (checking connection)
        connectionText.textContent = 'Checking blockchain connection...';
        statusDot.style.backgroundColor = '#F59E0B'; // Orange
        statusDot.style.border = '2px solid #F59E0B';
        connectionText.style.color = '#F59E0B';
        blockchainIndicator.style.backgroundColor = '#fefcbf'; // Light orange background
    }
}

async function checkWalletConnection() {
    if (typeof window.ethereum !== 'undefined') {
        try {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts.length > 0) {
                userAccount = accounts[0];
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(CONFIG.CONTRACT_ABI, CONFIG.CONTRACT_ADDRESS);
                updateConnectionStatus(true, userAccount);
            } else {
                updateConnectionStatus(false);
            }
        } catch (error) {
            console.error('Error checking wallet:', error);
            updateConnectionStatus(false);
        }
    } else {
        updateConnectionStatus(false);
    }
}

// View profile modal
// function viewProfile() {
//     const user = JSON.parse(localStorage.getItem('user'));
//     if (user) showProfileModal(user);
//     toggleDropdown();
// }

function editProfile() {
    window.location.href = '/edit-profile';
    toggleDropdown();
}

function showProfileModal(user) {
    const modal = `
        <div class="modal-overlay" onclick="closeProfileModal()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>Profile Information</h3>
                    <button onclick="closeProfileModal()" class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="profile-info">
                        <div class="info-row"><label>Email:</label><span>${user.primary_email}</span></div>
                        <div class="info-row"><label>Role:</label><span>${user.role}</span></div>
                        <div class="info-row"><label>Company:</label><span>${user.current_company_name}</span></div>
                        <div class="info-row"><label>Wallet:</label><span>${user.primary_wallet}</span></div>
                        <div class="info-row"><label>Status:</label><span style="color: ${user.verification_status === 'verified' ? '#10b981' : '#f59e0b'}">${user.verification_status}</span></div>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
}

function closeProfileModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) modal.remove();
}


// Generate random serial number
function generateSerialNumber() {
    const prefix = 'TEST';
    const timestamp = Date.now().toString().slice(-6);
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    const serialNumber = `${prefix}${timestamp}${random}`;
    
    document.getElementById('serial_number').value = serialNumber;
    
    // Optional: Show confirmation
    alert(`Generated serial: ${serialNumber}`);
}

// Show/hide product form
function showProductForm() {
    const form = document.getElementById('product-form');
    if (form) form.style.display = form.style.display === 'block' ? 'none' : 'block';
}
// Fixed registerProductOnBlockchain function
async function registerProductOnBlockchain(productData) {
    const registerBtn = document.getElementById('register-btn');
    const btnText = registerBtn.querySelector('.btn-text');
    const btnSpinner = registerBtn.querySelector('.btn-spinner');
    
    let productId = null; 
    try {
        // Show loading state
        registerBtn.disabled = true;
        btnText.style.display = 'none';
        btnSpinner.style.display = 'inline';
        
        // Get user data
        const user = JSON.parse(localStorage.getItem('user'));
        const manufacturerWallet = user.primary_wallet;
        
        // Generate specification hash
        const specificationHash = await generateSpecHash(productData);
        
        showTransactionModal('Checking for duplicates...');
        
        // STEP 1: Check if product already exists on blockchain
        try {
            const existsOnBlockchain = await contract.methods.serialExists(productData.serialNumber).call();
            if (existsOnBlockchain) {
                throw new Error(`Product with serial number ${productData.serialNumber} already exists on blockchain`);
            }
        } catch (duplicateError) {
            if (duplicateError.message.includes('already exists')) {
                throw duplicateError;
            }
            console.warn('Could not check blockchain duplicates:', duplicateError.message);
        }
        
        // Add delay to ensure modal update is visible
        await new Promise(resolve => setTimeout(resolve, 1000));
        updateTransactionStatus('Saving to database...');
        
        // STEP 2: Save to backend database first (FIXED: Only once)
        const backendResponse = await axios.post('/manufacturer/register-product', {
            serialNumber: productData.serialNumber,
            brand: productData.brand,
            model: productData.model,
            deviceType: productData.deviceType,
            storageData: productData.storageData,
            color: productData.color,
            batchNumber: productData.batchNumber,
            manufacturerWallet: manufacturerWallet,
            specificationHash: specificationHash,
            registrationType: 'blockchain_pending' // This prevents double saves
        }, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (backendResponse.data.status !== "success") {
            throw new Error(backendResponse.data.error || backendResponse.data.message || 'Backend registration failed');
        }
        
        productId = backendResponse.data.product_id;
        
        // FIXED: Add delay and ensure modal update shows
        await new Promise(resolve => setTimeout(resolve, 1500));
        updateTransactionStatus('✅ Database saved! Preparing blockchain transaction...');
        
        // STEP 3: Register on blockchain with correct parameters
        const gasEstimate = await contract.methods.registerDevice(
            productData.serialNumber,
            productData.brand,
            productData.model,
            productData.deviceType,
            productData.storageData || "N/A",
            productData.color || "N/A",
            productData.batchNumber || `BATCH-${Date.now()}`,
            specificationHash
        ).estimateGas({ from: userAccount });

        const gasPrice = web3.utils.toWei('2', 'gwei');
        const gasLimit = Math.floor(gasEstimate * 1.2);

        await new Promise(resolve => setTimeout(resolve, 1000));
        updateTransactionStatus('📡 Sending blockchain transaction...');

        const result = await contract.methods.registerDevice(
            productData.serialNumber,
            productData.brand,
            productData.model,
            productData.deviceType,
            productData.storageData || "N/A",
            productData.color || "N/A",
            productData.batchNumber || `BATCH-${Date.now()}`,
            specificationHash
        ).send({
            from: userAccount,
            gas: gasLimit,
            gasPrice: gasPrice
        });
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        updateTransactionStatus('⛓️ Blockchain confirmed! Updating database...');
        
        // STEP 4: Update backend with blockchain confirmation (NOT creating new record)
        const ownershipData = {
            owner_address: manufacturerWallet,
            owner_type: 'manufacturer',
            owner_name: user.current_company_name || user.company_names?.[0] || 'Unknown',
            transfer_date: new Date().toISOString(),
            transfer_type: 'initial_registration',
            transaction_hash: result.transactionHash,
            notes: 'Initial product registration on blockchain'
        };
        
        // FIXED: Use PUT to update existing record, not create new one
        await axios.put(`/products/${productId}/blockchain-confirm`, {
            transactionHash: result.transactionHash,
            blockNumber: result.blockNumber,
            gasUsed: result.gasUsed,
            gasPrice: gasPrice,
            registrationType: 'blockchain_confirmed',
            ownershipData: ownershipData
        }, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                'Content-Type': 'application/json'
            }
        });
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        updateTransactionStatus(`
            <div style="color: #10b981; text-align: center;">
                <h4>🎉 Product Registered Successfully!</h4>
                <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <p><strong>Serial:</strong> ${productData.serialNumber}</p>
                    <p><strong>Brand:</strong> ${productData.brand} ${productData.model}</p>
                    <p><strong>Transaction:</strong> 
                        <a href="https://sepolia.etherscan.io/tx/${result.transactionHash}" target="_blank" style="color: #0066cc;">
                            View on Etherscan ↗
                        </a>
                    </p>
                    <p><strong>Gas Used:</strong> ${result.gasUsed.toLocaleString()}</p>
                </div>
                <small>This modal will close automatically in 15 seconds</small>
            </div>
        `);
        
        showAlert(`Product "${productData.brand} ${productData.model}" registered successfully!`, 'success');
        
        // Reset form and refresh data
        document.getElementById('product-registration-form').reset();
        setTimeout(() => {
            closeTransactionModal();
            hideProductForm();
            refreshDashboard();
        }, 15000);
        
    } catch (error) {
        console.error('Registration error:', error);
        
        let errorMessage = 'Registration failed';
        
        if (error.code === 401) {
            errorMessage = 'Transaction rejected by user';
        } else if (error.message.includes('already exists')) {
            errorMessage = error.message;
        } else if (error.message.includes('insufficient funds')) {
            errorMessage = 'Insufficient ETH for gas fees';
        } else if (error.message.includes('execution reverted')) {
            if (error.message.includes('Only authorized manufacturers')) {
                errorMessage = 'Your wallet is not authorized as a manufacturer';
            } else if (error.message.includes('Serial number already exists')) {
                errorMessage = 'Product with this serial number already exists';
            } else {
                errorMessage = 'Smart contract rejected the transaction';
            }
        } else if (error.response) {
            errorMessage = error.response.data.error || error.response.data.message || 'Backend error';
        } else if (error.message.includes('Product registered successfully')) {
            errorMessage = 'Registration completed but with warnings';
            showAlert('Registration completed successfully!', 'success');
        } else {
            errorMessage = error.message || 'Unknown error occurred';
        }
        
        if (!error.message.includes('Product registered successfully')) {
            showAlert(errorMessage, 'error');
        }
        
        updateTransactionStatus(`
            <div style="color: ${error.message.includes('Product registered successfully') ? '#10b981' : '#ef4444'}; text-align: center;">
                <h4>${error.message.includes('Product registered successfully') ? '✅ Registration Complete!' : '❌ Registration Failed'}</h4>
                <div style="background: ${error.message.includes('Product registered successfully') ? '#f0fdf4' : '#fef2f2'}; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <p>${errorMessage}</p>
                </div>
            </div>
        `);
        
        // FIXED: Only update error status if there was actually an error
        if (productId && !error.message.includes('Product registered successfully')) {
            try {
                await axios.put(`/products/${productId}/blockchain-failed`, {
                    error: error.message,
                    registrationType: 'blockchain_failed'
                }, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
            } catch (updateError) {
                console.error('Failed to update backend with error status:', updateError);
            }
        }
        
    } finally {
        registerBtn.disabled = false;
        btnText.style.display = 'inline';
        btnSpinner.style.display = 'none';
    }
}

// FIXED: Centered Modal CSS
const modalStyles = `
<style>
.transaction-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    backdrop-filter: blur(4px);
}

.transaction-modal-content {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.transaction-modal-header {
    text-align: center;
    margin-bottom: 20px;
}

.transaction-modal-header h3 {
    color: #333;
    margin: 0;
    font-size: 1.5rem;
}

.transaction-modal-body {
    text-align: center;
    line-height: 1.6;
}

.transaction-modal-close {
    position: absolute;
    top: 15px;
    right: 20px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
    padding: 0;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.transaction-modal-close:hover {
    background: #f0f0f0;
    color: #333;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
`;

// FIXED: Modal Functions
function showTransactionModal(message) {
    // Remove existing modal if any
    const existingModal = document.getElementById('transaction-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add styles if not already added
    if (!document.getElementById('modal-styles')) {
        const styleSheet = document.createElement('style');
        styleSheet.id = 'modal-styles';
        styleSheet.textContent = modalStyles.replace('<style>', '').replace('</style>', '');
        document.head.appendChild(styleSheet);
    }
    
    const modal = document.createElement('div');
    modal.id = 'transaction-modal';
    modal.className = 'transaction-modal';
    modal.innerHTML = `
        <div class="transaction-modal-content">
            <button class="transaction-modal-close" onclick="closeTransactionModal()">×</button>
            <div class="transaction-modal-header">
                <h3>🔄 Processing Transaction</h3>
            </div>
            <div class="transaction-modal-body" id="transaction-status">
                <div class="loading-spinner"></div>
                <p>${message}</p>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function updateTransactionStatus(message) {
    const statusElement = document.getElementById('transaction-status');
    if (statusElement) {
        // Add a small delay to ensure the message is visible
        setTimeout(() => {
            statusElement.innerHTML = `
                <div class="loading-spinner"></div>
                <div>${message}</div>
            `;
        }, 100);
    }
}

function closeTransactionModal() {
    const modal = document.getElementById('transaction-modal');
    if (modal) {
        modal.style.animation = 'modalSlideOut 0.3s ease-in forwards';
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
}

// Add slide out animation
const additionalStyles = `
@keyframes modalSlideOut {
    from {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
    to {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
    }
}
`;

// Add the additional styles
document.head.insertAdjacentHTML('beforeend', `<style>${additionalStyles}</style>`);


// Handle product registration form submit
async function handleProductSubmit(event) {
    event.preventDefault();

    // Validate wallet connection
    await checkWalletConnection();
    if (!userAccount) {
        showAlert('Please connect your MetaMask wallet.', 'error');
        return;
    }

    // Get and validate form data
    const serialNumber = document.getElementById('serial_number').value?.trim();
    const brand = document.getElementById('brand').value?.trim();
    const model = document.getElementById('model').value?.trim();
    const deviceType = document.getElementById('device_type').value?.trim();

    if (!serialNumber || !brand || !model || !deviceType) {
        showAlert('All fields are required and must be filled.', 'error');
        return;
    }

    try {
        // Step 1: Register in DB
        const dbResponse = await axios.post('/manufacturer/register-product', {
            serial_number: serialNumber,
            brand: brand,
            model: model,
            device_type: deviceType
        });
        const productId = dbResponse.data.product_id || dbResponse.data.productId;
        if (!productId) {
            console.error('DB Response:', dbResponse.data);
            throw new Error('No product ID returned from DB registration');
        }
        showAlert('Product registered in DB successfully!', 'success');

        // Step 2: Proceed to blockchain registration
        const productData = {
            serialNumber: serialNumber,
            brand: brand,
            model: model,
            deviceType: deviceType,
            storageData: document.getElementById('storage_data').value?.trim() || 'N/A',
            color: document.getElementById('color').value?.trim() || 'N/A',
            batchNumber: document.getElementById('batch_number').value?.trim() || `BATCH-${Date.now()}`
        };
        await registerProductOnBlockchain(productData);

    } catch (error) {
        console.error('Registration error:', error);
        showAlert(`Error in registration flow: ${error.message}`, 'error');
    }
}


  // Load manufacturer's products
        async function loadManufacturerProducts() {
            loading = document.querySelector('.loading')
            loading.innerHTML = `<div class="spinner"></div>`
            try {
                const response = await axios.get(`/manufacturer/products?_t=${Date.now()}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                }
            });
                if (response && response.data && response.data.products) {
                    displayProducts(response.data.products);

                } else {
                    document.getElementById('manufacturer-products').innerHTML = 
                        '<div class="error">No Products Available</div>';
                }
                loading.style.display = "none";

                
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('manufacturer-products').innerHTML = 
                    '<div class="error">Failed to load products</div>';
            }
        }

// Connect wallet
function connectWallet() {
    if (typeof window.ethereum !== 'undefined') {
        window.ethereum.request({ method: 'eth_requestAccounts' }).then(accounts => {
            userAccount = accounts[0];
            web3 = new Web3(window.ethereum);
            contract = new web3.eth.Contract(CONFIG.CONTRACT_ABI, CONFIG.CONTRACT_ADDRESS);
            updateConnectionStatus(true, userAccount);
            showAlert('Wallet connected successfully!', 'success');
        }).catch(error => {
            console.error('Error connecting wallet:', error);
            showAlert('Failed to connect wallet.', 'error');
        });
    } else {
        showAlert('Please install MetaMask!', 'error');
    }
}

        
async function refreshDashboard() {
    const token = localStorage.getItem('authToken');
    if (token) {
        axios.get(`/manufacturer/dashboard-stats?_t=${Date.now()}`, {
            headers: { Authorization: `Bearer ${token}` }
        })
        .then(response => {
            const { total_products, blockchain_products, pending_products, total_verifications } = response.data;
            document.getElementById('total-products').textContent = total_products || 0;
            document.getElementById('blockchain-products').textContent = blockchain_products || 0;
            document.getElementById('pending-products').textContent = pending_products || 0;
            document.getElementById('total-verifications').textContent = total_verifications || 0;
            loadUserProducts()
        })
        .catch(error => {
            console.error('Error refreshing dashboard:', error);
            showAlert('Failed to refresh dashboard data.', 'error');
        });
    }
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    checkWalletConnection();
    const token = localStorage.getItem('authToken');
    const userString = localStorage.getItem('user');
    
    if (token && userString) {
        try {
            const user = JSON.parse(userString);

            if (user.role) {
                loadUserProfile(user.role);
                refreshDashboard();
                loadManufacturerProducts();
            } else {
                console.error('User role not found');
                // Handle missing role - maybe redirect to profile completion
            }
        } catch (error) {
            console.error('Error parsing user data:', error);
            // Handle invalid user data - maybe clear storage and redirect
            localStorage.removeItem('user');
            localStorage.removeItem('authToken');
            window.location.href = '/login';
        }
    } else {
        window.location.href = '/login';
    }

    // Attach form submit handler
    const form = document.getElementById('product-registration-form');
    if (form) form.onsubmit = handleProductSubmit;
});

// New function to check if the connected wallet is authorized as a manufacturer
async function checkManufacturerAuthorization() {
    if (!contract || !userAccount) return;
    
    try {
        const isAuthorized = await contract.methods.isManufacturerAuthorized(userAccount).call();
        
        if (!isAuthorized) {
            showAlert('Warning: Your wallet is not authorized as a manufacturer on the blockchain', 'warning');
            updateConnectionStatus(true, userAccount, 'Connected but not authorized as manufacturer');
        }
    } catch (error) {
        console.error('Error checking manufacturer authorization:', error);
        // Don't show error for this check, just log it
    }
}

// Listen for account changes
if (typeof window.ethereum !== 'undefined') {
    window.ethereum.on('accountsChanged', function (accounts) {
        if (accounts.length === 0) {
            // User disconnected
            userAccount = null;
            web3 = null;
            contract = null;
            updateConnectionStatus(false, null, 'Wallet disconnected');
        } else {
            // User switched accounts
            userAccount = accounts[0];
            updateConnectionStatus(true, userAccount);
            checkManufacturerAuthorization();
        }
    });

    window.ethereum.on('chainChanged', function (chainId) {
        // Reload the page when chain changes
        window.location.reload();
    });
}

// Updated switch to Sepolia function
async function switchToSepolia() {
    try {
        await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: `0x${window.CONFIG.CHAIN_ID.toString(16)}` }],
        });
    } catch (switchError) {
        // This error code indicates that the chain has not been added to MetaMask
        if (switchError.code === 4902) {
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: `0x${window.CONFIG.CHAIN_ID.toString(16)}`,
                        chainName: 'Sepolia Test Network',
                        nativeCurrency: { 
                            name: 'ETH', 
                            symbol: 'ETH', 
                            decimals: 18 
                        },
                        rpcUrls: ['https://sepolia.infura.io/v3/'],
                        blockExplorerUrls: ['https://sepolia.etherscan.io/']
                    }]
                });
            } catch (addError) {
                console.error('Error adding network:', addError);
                showAlert('Failed to add Sepolia network', 'error');
            }
        } else {
            console.error('Error switching network:', switchError);
            showAlert('Failed to switch to Sepolia network', 'error');
        }
    }
}

    //HTML form
const formHtml = `
<form id="product-registration-form" method="post" action="">
    <input type="text" name="serial_number" required placeholder="Serial Number">
    <input type="text" name="name" required placeholder="Product Name">
    <input type="text" name="category" required placeholder="Category">
    <input type="text" name="description" placeholder="Description">
    <input type="number" name="price" required placeholder="Price">
    <button type="submit" class="form-submit">Register Product</button>
</form>
`;

        // Dashboard-specific functions
        function showProductForm() {
            const form = document.getElementById('product-form');
            form.style.display = 'block';
            form.scrollIntoView({ behavior: 'smooth' });
        }
        
        function hideProductForm() {
            const form = document.getElementById('product-form');
            form.style.display = 'none';
        }

        // Generate random serial number
//Updated generate spec hash function
async function generateSpecHash(productData) {
    try {
        const specString = `${productData.serialNumber}${productData.brand}${productData.model}${productData.deviceType}${productData.storageData || ''}${productData.color || ''}`;
        const encoder = new TextEncoder();
        const data = encoder.encode(specString);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return '0x' + hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    } catch (error) {
        console.error('Error generating spec hash:', error);
        // Fallback hash
        return '0x' + Math.random().toString(16).substr(2, 64);
    }
}
    
document.getElementById('product-registration-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!contract || !userAccount) {
        showAlert('Please connect your wallet first!', 'error');
        return;
    }
    
    const formData = new FormData(e.target);
    const productData = {
        serialNumber: formData.get('serial_number'),
        brand: formData.get('brand'),
        model: formData.get('model'),
        deviceType: formData.get('device_type'),
        storageData: formData.get('storage_data') || 'N/A',
        color: formData.get('color') || 'N/A',
        batchNumber: formData.get('batch_number') || `BATCH-${Date.now()}`
    };
    
    // Validate required fields
    if (!productData.serialNumber || !productData.brand || !productData.model || !productData.deviceType) {
        showAlert('Please fill in all required fields', 'error');
        return;
    }
    console.log('Submitting product data:', productData);
    
    await registerProductOnBlockchain(productData);
});

// Updated generate spec hash function with better error handling
async function generateSpecHash(productData) {
    try {
        const specString = `${productData.serialNumber}${productData.brand}${productData.model}${productData.deviceType}${productData.storageData}${productData.color}`;
        const encoder = new TextEncoder();
        const data = encoder.encode(specString);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return '0x' + hashArray.map(b => b.toString(16).padStart(2, '0')).join('').slice(0, 64); // Full hash
    } catch (error) {
        console.error('Error generating spec hash:', error);
        // Fallback hash generation
        return '0x' + Math.random().toString(16).substr(2, 64);
    }
}


async function loadUserProducts() {
    // loadingState = document.querySelector('.loading')
    // loadingState.style.display = "block"
    try {
        const response = await axios.get('/manufacturer/products', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
            }
        });
        
        const select = document.getElementById('transfer_serial');
        select.innerHTML = '<option value="">Select product to transfer</option>';
        
        if (response.data.products) {
            response.data.products
                .filter(p => p.registration_type === 'blockchain_confirmed')
                .forEach(product => {
                    select.innerHTML += `<option value="${product.serial_number}">
                        ${product.serial_number} - ${product.name || product.brand + ' ' + product.model}
                    </option>`;
                });
        }
    } catch (error) {
        console.error('Error loading products:', error);
        showAlert('Failed to load products for transfer', 'error');
    }
}

       
async function filterProducts() {
    const filter = document.getElementById('products-filter').value;
    
    try {
        let url = `/manufacturer/products?_t=${Date.now()}`;
        if (filter !== 'all') {
            url += `&filter=${filter}`;
        }
        
        const response = await axios.get(url, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
            }
        });
        
        if (response && response.data && response.data.products) {
            displayProducts(response.data.products);
        } else {
            document.getElementById('manufacturer-products').innerHTML = 
                '<div class="error">No Products Available</div>';
        }
    } catch (error) {
        console.error('Error filtering products:', error);
        showAlert('Failed to filter products', 'error');
    }
}

// Transfer ownership functions
function showTransferForm() {
    const form = document.getElementById('transfer-form');
    form.style.display = 'block';
    form.scrollIntoView({ behavior: 'smooth' });
}

function hideTransferForm() {
    document.getElementById('transfer-form').style.display = 'none';
}


// Transfer ownership form handler
document.getElementById('ownership-transfer-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!contract || !userAccount) {
        showAlert('Please connect your wallet first!', 'error');
        return;
    }
    
    const formData = new FormData(e.target);
    const transferData = {
        serialNumber: formData.get('transfer_serial'),
        newOwnerAddress: formData.get('new_owner_address'),
        transferReason: formData.get('transfer_reason'),
        salePrice: parseFloat(formData.get('sale_price') || '0')
    };
    
    await transferProductOwnership(transferData);
});

async function transferProductOwnership(transferData) {
    const transferBtn = document.getElementById('transfer-btn');
    const btnText = transferBtn.querySelector('.btn-text');
    const btnSpinner = transferBtn.querySelector('.btn-spinner');
    
    try {
        transferBtn.disabled = true;
        btnText.style.display = 'none';
        btnSpinner.style.display = 'inline';
        
        showTransactionModal('Preparing ownership transfer...');
        
        // Convert ETH to Wei for blockchain
        const salePriceWei = web3.utils.toWei(transferData.salePrice.toString(), 'ether');
        
        const gasEstimate = await contract.methods.transferOwnership(
            transferData.serialNumber,
            transferData.newOwnerAddress,
            transferData.transferReason,
            salePriceWei
        ).estimateGas({ from: userAccount });

        const gasPrice = web3.utils.toWei('2', 'gwei');
        const gasLimit = Math.floor(gasEstimate * 1.1);

        updateTransactionStatus('Sending transfer transaction...');

        const result = await contract.methods.transferOwnership(
            transferData.serialNumber,
            transferData.newOwnerAddress,
            transferData.transferReason,
            salePriceWei
        ).send({
            from: userAccount,
            gas: gasLimit,
            gasPrice: gasPrice
        });
        
        // Update database
        await axios.post('/products/transfer-ownership', {
            serialNumber: transferData.serialNumber,
            newOwnerAddress: transferData.newOwnerAddress,
            transferReason: transferData.transferReason,
            salePrice: transferData.salePrice,
            transactionHash: result.transactionHash,
            blockNumber: result.blockNumber
        }, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                'Content-Type': 'application/json'
            }
        });
        
        updateTransactionStatus(`
            <div style="color: #10b981;">
                <h4>✅ Ownership Transferred!</h4>
                <p><strong>Product:</strong> ${transferData.serialNumber}</p>
                <p><strong>New Owner:</strong> ${transferData.newOwnerAddress.slice(0, 10)}...</p>
                <p><strong>Transaction:</strong> 
                    <a href="https://sepolia.etherscan.io/tx/${result.transactionHash}" target="_blank">
                        ${result.transactionHash.slice(0, 10)}...
                    </a>
                </p>
            </div>
        `);
        
        showAlert(`Ownership of ${transferData.serialNumber} successfully transferred!`, 'success');
        
        document.getElementById('ownership-transfer-form').reset();
        refreshDashboard();
        setTimeout(() => {
            closeTransactionModal();
            hideTransferForm();
        }, 15000);
        
    } catch (error) {
        console.error('Transfer error:', error);
        
        let errorMessage = 'Transfer failed';
        if (error.message.includes('User denied')) {
            errorMessage = 'Transaction was rejected by user';
        } else if (error.message.includes('Only device owner')) {
            errorMessage = 'You are not the current owner of this device';
        } else {
            errorMessage = `Transfer failed: ${error.message}`;
        }
        
        showAlert(errorMessage, 'error');
        updateTransactionStatus(`<div style="color: #ef4444;"><h4>❌ Transfer Failed</h4><p>${errorMessage}</p></div>`);
        
    } finally {
        transferBtn.disabled = false;
        btnText.style.display = 'inline';
        btnSpinner.style.display = 'none';
    }
}
       
        // Transaction modal functions
        function showTransactionModal(message) {
            const modal = document.getElementById('transaction-modal');
            const status = document.getElementById('transaction-status');
            status.innerHTML = `<div class="loading">${message}</div>`;
            modal.style.display = 'block';
        }
        
        function updateTransactionStatus(message) {
            const status = document.getElementById('transaction-status');
            status.innerHTML = message;
        }
        
        function closeTransactionModal() {
            const modal = document.getElementById('transaction-modal');
            modal.style.display = 'none';
        }

    
      
        // Display products in grid
        function displayProducts(products) {
            const container = document.getElementById('manufacturer-products');
            
            if (!products || products.length === 0) {
                container.innerHTML = '<div class="empty-state">No products registered yet</div>';
                return;
            }
            
            const productsHTML = products.map(product => `
                <div class="product-card">
                    <div class="placeholder-image">📦</div>
                    <div class="product-info">
                        <h4>${product.name}</h4>
                        <p class="product-serial">SN: ${product.serial_number}</p>
                        <p class="product-category">${product.category}</p>
                        <p class="product-price">$${product.price}</p>
                        <div class="product-status ${product.registration_type}">
                            ${getStatusBadge(product.registration_type)}
                        </div>
                        ${product.transaction_hash ? 
                            `<a href="https://sepolia.etherscan.io/tx/${product.transaction_hash}" 
                               target="_blank" class="blockchain-link">View on Blockchain</a>` : 
                            ''
                        }
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = productsHTML;
        }

        // Get status badge for product
        function getStatusBadge(registrationType) {
            switch (registrationType) {
                case 'blockchain_confirmed':
                    return '<span class="status-badge success">✅ On Blockchain</span>';
                case 'blockchain_pending':
                    return '<span class="status-badge warning">⏳ Pending</span>';
                case 'blockchain_failed':
                    return '<span class="status-badge error">❌ Failed</span>';
                case 'database_only':
                    return '<span class="status-badge info">🗄️ Database Only</span>';
                default:
                    return '<span class="status-badge">Unknown</span>';
            }
        }


            
    </script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script src="/static/js/main.js"></script>
</body>
</html>